<!--
 * Copyright (c) 2025 by Albresky, All Rights Reserved. 
 * 
 * @Author: Albresky albre02@outlook.com
 * @Date: 2025-03-30 13:18:20
 * @LastEditTime: 2025-04-04 19:00:17
 * @FilePath: /BUPT-EDA-Labs/lab1/README.md
 * 
 * @Description: Lab1 题解
-->

## 🗒️ 题目：简单通信信号同步电路设计

设计一个通信调制信号的同步电路，实现对输入的中频信号的变频和同步。题目不涉及实体硬件电路，所有功能的设计及仿真均在 EDA 开发环境中实现，根据总体设计框图及说明、各个模块电路设计说明、时序说明、仿真结果、资源报告、设计总结和程序源代码评定实验结果。

### 任务一：简单通信信号同步电路设计

设计一个可应用于扩频通信中的扩频同步电路，实现输入的扩频中频信号的下变频和码同步电路。

![](./image/lab1.png)

**输入信号描述**

输入的中频信号 $\text{IF}\_{in}$ 使用 2 位精度采样，采样数据使用补码表示。输入的中频信号 $\text{IF}\_{in}$ 可由如下表达式表示：

```math
\text{IF}_{in} = f(D \oplus M) \cdot \cos(2\pi f n T + \phi)
```

```math
f(x) = \begin{cases} 1, & x=1 \\ -1, & x=0 \end{cases}
```

其中，符号 $\oplus$ 表示异或操作， $f(x)$ 为**极化函数**， $D$ 为信号中调制的**二进制数据序列**，**数据速率**为 *1kbps*， $M$ 为用于扩频的**伪随机码序列**，由循环长度为 *31* 的 **$m$ 码**产生。 $M$ 的速率 (即**码片速率**) 为 *31kbps*，其每一位所占的时间称为一个**码片周期**。数据位 $D$ 的每一位都与 $M$ 序列的一个循环周期对齐。 $f$ 为**载波频率**， $f=124kHz$， $n$ 为**采样序列标号**， $T$ 是**采样周期**，采用载波频率的 4 倍采样。

**信号同步原理**

在信号接收端，中频信号 $\text{IF}\_{in}$ 经采样后输入该同步电路，在下变频操作中，使用本地载波产生电路产生的两路本地载波信号 $s\_1 (n)$、 $s\_2(n)$ 与输入信号 $\text{IF}\_{in}$ 相乘，得到两路下变频信号 $I$ 和 $Q$ (分别为同相支路、正交支路)，其中本地载波信号为

$$ s\_1 (n) = \cos(2\pi f n T + \phi) $$
$$ s\_2 (n) = \sin(2\pi f n T + \phi) $$

随后，将两路下变频信号与本地码产生器产生的本地码序列进行相关操作 (若本地码为 *1*，则乘以 *1*，若本地码为 *0*，则乘以 *-1*)，并在 $TS=1ms$ 的时长内对相关后的两路信号进行积分，两路信号的积分结果分别为 $I$、 $Q$，并求能量信号 $S=I^2+Q^2$。

由于 **m 码** 的互相关和自相关特性，当本地码产生器的相位与发送端码产生器产生的序列相位一致时，积分结果 $S$ 可达到最大值，当两者不一致时， $S$ 保持一个较小值。因此，可设定一门限值 $S_{th}$ 与积分结果 $S$ 相比较，若 $S \lt S_{th}$，可认为本地码产生器与发送端码产生器未达到同步状态，此时应将本地码产生器的相位延后一个码片周期，并重新开始积分过程，直至达到 $S \ge S_{th}$，即本地码产生器与发送端码产生器同步的状态。


### 任务二：testbench 编写实验

(1) 设计上述电路的 testbench，调制的电文 $D$ 可自行定义。对设计的电路进行是进行仿真。

(2) 若有必要，可添加其他模块，在设计各模块时，可以添加其他信号，但不要更改设计要求中定义的信号。

### 三、任务三：利用 AI 辅助设计复杂信号捕获电路（附加）

阅读北斗 ICD 及北斗信号捕获参考文献，在任务一、任务二的基础上。借助 AI 工具，设计北斗 B1I 信号的捕获电路及仿真代码，完成信号同步


## ✍️ 题解


### 一、如何实现积分器的 1ms 积分区间 ?

**1. 码片速率与数据速率的关系：**

- 码片速率 = 31kHz

- 数据速率 = 1kHz

由此可知，每个数据位对应 31 个码片（31kHz ÷ 1kHz = 31）

**2. 采样率的计算：**

- 载波频率 = 124kHz

- 采样率 = 4 × 载波频率 = 496kHz

**3. 每个码片的采样点数：**

- `SAMPLES_PER_CHIP` = 采样率 ÷ 码片速率

- `SAMPLES_PER_CHIP` = 496kHz ÷ 31kHz = 16

**4. 1ms 内的总采样点数：**

1ms 内的采样点数 = 采样率 × 0.001s = 496kHz × 0.001s = 496


**5. 积分时长的等价表达：**

在前面我们已知每个数据位持续 1ms（数据速率 1kHz），每个数据位对应一个完整的 m 码周期（31个码片）。因此，1ms 积分时长 = 31个码片 × 16个采样点/码片 = 496个采样点。

**实现**：积分器通过累积 `SAMPLES_PER_CHIP * CODE_LENGTH = 16 × 31 = 496` 个采样点来实现 1ms 的积分区间。

```cpp
void Integrator(float I_in, float Q_in, float &I_sum, float &Q_sum,
                ap_uint<16> &sample_count, bool &integral_done) {
#pragma HLS INLINE
  I_sum += I_in;
  Q_sum += Q_in;

  if (++sample_count >= SAMPLES_PER_CHIP * CODE_LENGTH) { // 31位码片*16=496
    integral_done = true;
    sample_count = 0;
  } else {
    integral_done = false;
  }
}
```

### 二、如何检测和校正本地载波相位误差


 - 当本地载波与接收信号不同相时， $I$ / $Q$两路积分结果会产生偏差
 - 采用简单的相位检测器：当I值为正时， $Q$ 值反映相位误差；当I值为负时，取 $Q$ 的负值作为相位误差
 - 使用比例控制算法更新相位估计值

**实现：**

```cpp
// 相位误差计算
float PhaseDetector(float I, float Q) { return (I > 0 ? Q : -Q); }

// 相位跟踪（在顶层函数中）
float phi_error = PhaseDetector(I_accum, Q_accum);
phi_est += KP_GAIN * phi_error;  // KP_GAIN为环路增益(0.01)
```


### 三、 如何调整本地 m 码相位使其与发送端同步？


m 码是 31 位伪随机序列，当本地 m 码与发送端 m 码同相位时，相关积分值达到最大。

使用门限判决法：设定能量门限值（ $S\_{th}=25$ ），比较能量值 $S=I^2+Q^2$ 与门限。当 $S \lt S\_{th}$ 时，将本地m码相位循环右移一位（延后一个码片周期）；每次调整后重新开始积分过程，直到达到同步。

**实现：**

```cpp
// 码相位控制器
void CodeController(bool sync_flag, ap_uint<5> &m_state) {
#pragma HLS INLINE
  if (!sync_flag) {
    m_state = (m_state >> 1) | (m_state[0] << 4); // 循环右移
  }
}
```


### 四、仿真结果

关键参数的波形如下。

**信号同步成功** 时：

![](./image/sync_visualization_case_ok.png)

**信号同步失败** 时：

![](./image/sync_visualization_case_fail.png)

# 任务三：利用 AI 辅助设计复杂信号捕获电路（附加）

## 北斗 B1I 信号特性

北斗 B1I 信号是北斗卫星导航系统（BDS）的主要民用信号之一，具有以下特点：

- **载波频率**：1561.098 MHz
- **调制方式**：BPSK 调制
- **码序列**：2046 位伪随机噪声（PRN）序列
- **码速率**：2.046 Mcps（每秒百万码片）
- **数据速率**：50 bps（每秒比特）

## 北斗 B1I 信号捕获原理

与简单通信信号同步类似，北斗信号捕获主要解决两个问题：

1. **码相位搜索**：确定接收信号中 PRN 码的起始位置
2. **载波频率搜索**：由于多普勒效应和接收机本振误差，需要搜索确定准确的载波频率

捕获过程通过在二维搜索空间（码相位 × 频率）中寻找相关峰值来实现。当本地生成的参考信号与接收信号匹配时，相关结果将产生明显的峰值。

## 捕获电路设计

设计的北斗 B1I 信号捕获电路包含以下关键模块：

1. **B1I 码生成器**：生成特定 PRN 号对应的 B1I 伪随机码
2. **本地载波生成器**：产生不同多普勒频移的本地载波参考信号
3. **并行码相位搜索**：实现快速码相位搜索
4. **相关计算与峰值检测**：计算相关值并检测峰值

### 关键参数设置

- **采样率**：16.368 MHz（8 倍码片率）
- **多普勒搜索范围**：±10 kHz
- **多普勒步进**：500 Hz
- **积分时间**：1 ms（一个完整码周期）
- **非相干积分次数**：10 次

## 实现细节

核心函数 `AcquireBeidouB1I` 实现了北斗 B1I 信号的完整捕获过程：

1. 生成特定 PRN 号的 B1I 码
2. 对每个多普勒频移进行搜索
3. 对每个码相位计算相关值
4. 找出最大相关值对应的码相位和多普勒频移
5. 计算信噪比并判断信号是否捕获成功
